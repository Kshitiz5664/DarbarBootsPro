{% load static %}
{% block page_title %}Retail Billing Console{% endblock %}

{% block billing_content %}
<div class="container-fluid py-3">
  <div class="row g-3">

    <!-- Left column: Invoice Workspace -->
    <div class="col-lg-8">
      <div class="card form-card mb-3">

        <div class="card-header form-header d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0"><i class="bi bi-cart3"></i> Retail Billing Console</h4>
            <small class="text-muted">Create invoice, add items, payments, returns — all in one place.</small>
          </div>

          <div>
            <a href="{% url 'retailapp:billing_console' %}" class="btn btn-outline-light btn-sm">Refresh</a>

            {% if active_invoice %}
            <a href="{% url 'retailapp:invoice_pdf' active_invoice.pk %}" target="_blank"
               class="btn btn-warning btn-sm ms-2">
              <i class="bi bi-download"></i> PDF
            </a>
            {% endif %}
          </div>
        </div>

        <div class="card-body">

          <!-- Create invoice -->
          <form action="{% url 'retailapp:invoice_create' %}" method="post"
                class="row g-2 align-items-end mb-3">
            {% csrf_token %}
            <div class="col-md-4">{{ invoice_form.customer_name }}</div>
            <div class="col-md-3">{{ invoice_form.customer_mobile }}</div>
            <div class="col-md-3">{{ invoice_form.date }}</div>
            <div class="col-md-2">
              <button class="btn btn-success w-100">Create Invoice</button>
            </div>
            <div class="col-12 mt-2">{{ invoice_form.notes }}</div>
          </form>

          {% if active_invoice %}
          <!-- Active invoice display -->
          <div class="invoice-workspace mb-3">

            <div class="d-flex justify-content-between">
              <div>
                <h5 class="mb-0">Invoice: <strong>{{ active_invoice.invoice_number }}</strong></h5>
                <div class="text-muted small">
                  {{ active_invoice.customer_name }} — {{ active_invoice.customer_mobile }}
                </div>
                <div class="text-muted small">Date: {{ active_invoice.date }}</div>
              </div>

              <div class="text-end">
                <div>Base: ₹{{ active_invoice.base_amount }}</div>
                <div>GST: ₹{{ active_invoice.total_gst }}</div>
                <div>Discount: ₹{{ active_invoice.total_discount }}</div>
                <h4 class="mt-1">Total: ₹{{ active_invoice.final_amount }}</h4>
                <div class="small text-muted">
                  Status:
                  {% if active_invoice.is_paid %}
                    <span class="badge bg-success">PAID</span>
                  {% else %}
                    <span class="badge bg-warning">OPEN</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <hr/>

            <!-- Add item -->
            <form action="{% url 'retailapp:item_add' active_invoice.pk %}" method="post"
                  class="row g-2 align-items-end">
              {% csrf_token %}
              <div class="col-md-4">{{ item_form.item }}</div>
              <div class="col-md-4">{{ item_form.manual_item_name }}</div>
              <div class="col-md-2">{{ item_form.quantity }}</div>
              <div class="col-md-2">{{ item_form.rate }}</div>

              <div class="col-12 mt-2">
                <div class="row g-2">
                  <div class="col-md-2">{{ item_form.gst_percent }}</div>
                  <div class="col-md-2">{{ item_form.discount_percent }}</div>
                  <div class="col-md-4">
                    <button class="btn btn-primary w-100">Add Item</button>
                  </div>
                </div>
              </div>
            </form>

            <!-- Items table -->
            <div class="table-responsive mt-3">
              <table class="table table-dark table-striped align-middle">
                <thead>
                  <tr>
                    <th>Item</th><th>Qty</th><th>Rate</th><th>GST</th>
                    <th>Discount</th><th>Total</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for it in active_items %}
                  <tr>
                    <td>{{ it.display_name }}</td>
                    <td>{{ it.quantity }}</td>
                    <td>₹{{ it.rate }}</td>
                    <td>₹{{ it.gst_amount }}</td>
                    <td>₹{{ it.discount_amount }}</td>
                    <td>₹{{ it.total }}</td>
                    <td>
                      <a href="{% url 'retailapp:item_edit' it.pk %}"
                         class="btn btn-sm btn-outline-light">Edit</a>
                      <a href="{% url 'retailapp:item_delete' it.pk %}"
                         class="btn btn-sm btn-danger"
                         onclick="return confirm('Remove item?')">Delete</a>
                    </td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="7" class="text-center text-muted">No items yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Returns and Payments -->
            <div class="row mt-3">

              <!-- Returns -->
              <div class="col-md-6">
                <h6>Returns</h6>

                <form action="{% url 'retailapp:return_add' active_invoice.pk %}"
                      method="post" enctype="multipart/form-data">
                  {% csrf_token %}
                  <div class="row g-2">
                    <div class="col-md-6">{{ return_form.item }}</div>
                    <div class="col-md-2">{{ return_form.quantity }}</div>
                    <div class="col-md-4">{{ return_form.amount }}</div>
                  </div>

                  <div class="row g-2 mt-2">
                    <div class="col-md-8">{{ return_form.reason }}</div>
                    <div class="col-md-4">
                      <button class="btn btn-outline-warning w-100">Add Return</button>
                    </div>
                  </div>
                </form>

                <div class="mt-2">
                  <table class="table table-dark table-sm">
                    <thead>
                      <tr><th>Item</th><th>Qty</th><th>Amount</th></tr>
                    </thead>
                    <tbody>
                      {% for r in active_returns %}
                      <tr>
                        <td>
                          {% if r.item %}
                            {{ r.item.display_name }}
                          {% else %}
                            Manual
                          {% endif %}
                        </td>
                        <td>{{ r.quantity }}</td>
                        <td>₹{{ r.amount }}</td>
                      </tr>
                      {% empty %}
                      <tr><td colspan="3" class="text-muted">No returns</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Payments (placeholder) -->
              <div class="col-md-6">
                <h6>Payments (simple manual flow)</h6>

                <form action="#" method="post" id="paymentForm">
                  {% csrf_token %}
                  <div class="row g-2">
                    <div class="col-md-4">
                      <select class="form-select" name="mode">
                        <option value="cash">Cash</option>
                        <option value="upi">UPI</option>
                        <option value="bank">Bank</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <input class="form-control" name="amount" type="number"
                             step="0.01" placeholder="Amount"/>
                    </div>
                    <div class="col-md-4">
                      <button class="btn btn-success w-100" type="button"
                              id="payNowBtn">Record Payment</button>
                    </div>
                  </div>
                </form>

                <div class="mt-2 text-muted small">
                  Payments can be stored once the Payment model is integrated.
                </div>
              </div>
            </div>

          </div>
          {% else %}
          <div class="text-center text-muted">No active invoice. Create one above.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right column: Invoice list -->
    <div class="col-lg-4">
      <div class="card form-card mb-3">
        <div class="card-body">
          <h5>Invoices</h5>
          <div class="list-group">
            {% for inv in invoices %}
            <a href="{% url 'retailapp:billing_console' %}?active={{ inv.pk }}"
               class="list-group-item list-group-item-action
               d-flex justify-content-between align-items-center
               {% if active_invoice and inv.pk == active_invoice.pk %}active{% endif %}">
              <div>
                <div><strong>{{ inv.invoice_number }}</strong></div>
                <div class="small text-muted">{{ inv.customer_name }}</div>
              </div>
              <div class="text-end">
                <div>₹{{ inv.final_amount }}</div>
                <div class="small text-muted">{{ inv.date }}</div>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="card form-card">
        <div class="card-body">
          <h6>Quick Stats</h6>
          <div class="d-flex justify-content-between">
            <div>Total invoices</div>
            <div><strong>{{ invoices|length }}</strong></div>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <div>Open (approx)</div>
            <div><strong>{{ invoices|length }}</strong></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const payBtn = document.getElementById('payNowBtn');
    if (payBtn) {
        payBtn.addEventListener('click', () => {
            alert('Payment flow pending integration.');
        });
    }
});
</script>
{% endblock %}
